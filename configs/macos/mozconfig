# This Source Code Form is subject to the terms of the Mozilla Public
# License, v. 2.0. If a copy of the MPL was not distributed with this
# file, You can obtain one at http://mozilla.org/MPL/2.0/.

unset MOZ_STDCXX_COMPAT

ac_add_options --disable-dmd
ac_add_options --enable-eme=widevine

if test "$ZEN_RELEASE"; then
  # override LTO settings
  # TODO: Dont use LTO for now, it's causing a lot of issues
  export MOZ_LTO=cross,thin
  ac_add_options --enable-lto=cross,thin
fi

if test "$ZEN_RELEASE"; then
  if test "$ZEN_GA_DISABLE_PGO"; then
    export ZEN_DUMMY=1
  else
    export MOZ_PGO=1
    ac_add_options MOZ_PGO=1
  fi
fi

if test "$SURFER_COMPAT" = "x86_64"; then
  ac_add_options --target=x86_64-apple-darwin

  if test "$ZEN_RELEASE"; then
    ac_add_options --enable-wasm-avx
    ac_add_options --enable-optimize="-march=nehalem -mtune=haswell -O3 -w"
  fi
else
  ac_add_options --enable-clang-plugin
  ac_add_options --target=aarch64-apple-darwin

  if test "$ZEN_RELEASE"; then
    ac_add_options --enable-optimize="-O3 -mcpu=apple-m1"

    # As of Clang 13, the default is -mcpu=apple-m1 when using a aarch64-apple-macos target,
    # but we're using apple64-apple-darwin, which defaults to -mcpu=apple-a7, which disables
    # a bunch of # performance-enabling CPU features.
    # TODO: We'll want to switch to aarch64-apple-macos eventually.
    export CFLAGS="$CFLAGS -mcpu=apple-m1"
    export CXXFLAGS="$CXXFLAGS -mcpu=apple-m1"

    # Keep using ld64 on PGO/LTO builds because of performance regressions when using lld.
    ac_add_options --enable-linker=ld64
  fi
fi
